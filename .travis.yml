sudo: false
dist: trusty
language: android

env:
  global:
    # set encrypted S3 credentials needed for deployment (commits on master branch)
    # we have to set this here instead of only on the deployment providers because
    # of this https://github.com/travis-ci/travis-ci/issues/6532
    #
    # see also: https://docs.travis-ci.com/user/encryption-keys/

    # AWS_ACCESS_KEY_ID: travis encrypt -r xbr/xbr-is-gold AWS_ACCESS_KEY_ID=".."
    - secure: "CifuU+uWPg+IelDoKjmL7m1HC++89p7AG8LRfSyy3SUfaub0SQ0ck6zHQvX9GTwx64CSSERF8Vn52cP0iEli0tIrk6k3eqPmfsVyEhRN6Z8rZ4/NfSH7D8CzZEdP+rODWIsxZ1/B0TDj7paYhDdlhBdp75K0ZYHXFyveDcG6RFWillQxfcvi7cpaT0OsVn9Ve8WMtbzZ4LQxTwxdgXDQwCpH41HpE2rCh5pij+0NOpgRYVjiSGjeDlhW96JYuc/jGda74F0PVLQ0Gjxd1M/gtVNXXrtLx3iaG0agiJ/YHitaXx0I1OqpxyfsT5csIP5ICCLv9PHsBioY71gToEXAY2QKJCwTf4zW4+nnelRABDIvszPp/SO5ozcfae+57LkjDlHYaQOUQK66S42c1bTbW6zWGTRCr07/2OC135Det7VTLXklr5OmEy8qQtH32KDqCNGha0NwPfs/9XQPuIt/QX3fpCyFR+0BdPBf7h3Gj6pxpdM4Kvg035oLyW6Y+/AWMd7HtQjlg9L6Olo6UlsraLQIc4u2Zgo5uEc3iK5GiPqYQ2yFGinUxMJmHmFLPZmW493G8j6XFXvUe9FbcLyOh4vrcJX8KEzAF3JdZjND+rkxnP/YFr8H4LGYyjgAhTZQqxnfYHUhp7xgHSclB6rUH4fGLLnQwf0Kg2EGGScHS9I="
    # AWS_SECRET_ACCESS_KEY: travis encrypt -r xbr/xbr-is-gold AWS_SECRET_ACCESS_KEY=".."
    - secure: "IB5cMtjKzyWSkTLycQCUdcr/w4daKW/kn6e7oD2x+POg2o05HVJ3+/uwPWmFeQEjIHGvNO3hIH1ShpGXfoD5t4ZleXdczM+rwAt0yichUJuZiu2D9Ylw8VQG++dF3rwQQsCk0Ntf1mnsPQVedW2svJUyLRRWMrWRWLuNX4QljvLetc4eToNVmVEd6fdvO5NYYDyepOSfyWYxxSk9/zbOl7hpNcfxVDtGzU1gP+A6JLeEJPVmfdFuGZcZhwT3cmYo0nGpvgwgUlgZcRZod6Vqvl4gNZf7/1zpyAknXxPz8BoOh2dUd2+CiVUp85Rh/XITpws6+pdmdzInMm9a9a0+EOdLbwp0PZLuQqJyKEwGp/MdxydhgPYGbGwUxmfrdx1IEvRQ5bjB3Vw17TnKHumxNXcNLHVTq3xRABYBlEvd3Ivi43niWgPnZhoLeCgWuUsJTuSuvlMhBNksVL1mrnnvX959jRJf2QBFoLId3Xhn9w0FvyycnFhBme0HhpStin0PB5k+YgLUlOoOMbC5PkoZ+aYYg/C7xAOWpqxwlLPY4akiPQ5ZpWtDT09gA+c2IHSXMmCf2ffMg3chnoWj2e9TBu485rEK0Vcm9HregbL4p24S+uxCG63z9nUSnUrOnrM26ubGiGaM18+in9MCo45QblewmW06tzN2ILdfuzBfQyI="

    # Company AWS S3 bucket where we upload artifacts
    - AWS_DEFAULT_REGION: "eu-central-1"
    - AWS_S3_BUCKET_NAME: "download.crossbario.com"

android:
  components:
    - tools
    - platform-tools
    - build-tools-27.0.3
    - android-27
  licenses:
    - 'android-sdk-preview-license-.+'
    - 'android-sdk-license-.+'
    - 'google-gdk-license-.+'

# https://docs.travis-ci.com/user/customizing-the-build#The-Build-Lifecycle
#
# - OPTIONAL Install apt addons
# - OPTIONAL Install cache components
# - before_install
# - install
# - before_script
# - script
# - OPTIONAL before_cache (for cleaning up cache)
# - after_success or after_failure
# - OPTIONAL before_deploy
# - OPTIONAL deploy
# - OPTIONAL after_deploy
# - after_script

addons:
  apt:
    update: true

cache:
  directories:
    - $HOME/.cache/pip
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

before_install:
  # https://docs.travis-ci.com/user/environment-variables/
  #
  # TRAVIS_BUILD_NUMBER: The number of the current build (for example, “4”).
  # TRAVIS_TAG: If the current build is for a git tag, this variable is set to the tag’s name.
  # TRAVIS_COMMIT: The commit that the current build is testing.
  - export CROSSBAR_BUILD_ID="$(date --utc "+%Y%m%d")-$(git rev-parse --short ${TRAVIS_COMMIT})"

# https://docs.travis-ci.com/user/languages/java/
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

# _if_ the deploy phase triggers, then this hook is run before and after _every_ deploy provider
before_deploy:
  # set up awscli package
  - pip install --user awscli
  - export PATH=$PATH:$HOME/.local/bin
  - which aws
  - aws --version
  - aws s3 ls ${AWS_S3_BUCKET_NAME}

# /home/travis/build/xbr/xbr-is-gold/app/build/outputs/apk/release/*
deploy:
  on:
    repo: xbr/xbr-is-gold
    branch: master
    # tags: true
  skip_cleanup: true
  provider: script
  script: pwd && ls -la && find . -name "*.apk" && sh .travis-deploy.sh

notifications:
  # https://crossbario.slack.com/services/BAWF261FE#service_setup
  # travis encrypt "crossbario:<SECRET>" -r xbr/xbr-is-gold
  slack:
    - secure: "P9CwD6RPSwErFTAfNi56OZzNxqn0OEVeWZTzoNyrh1jb9PzyPwHY8yIho8TOBpQcUALKFPxhqWDvXZRgeOmcskRXhg0RGX57BThvyMXNr/WKXfgJj86fuw1vte10SKJ8mOmxCV7ipFyfW/wnjwwNH6MXmn79mGBVh+PyQCw4s17iokXz6gGrnE6eQ2nhWiusZdl126sVUzazA4bQ99/KDYFH6tTYm5g1eBLBhq83u4dxQgEFEP+C9/Z/CKvybaffVYGequ6i/YxuyD58yR0Rwj4gPg1eRR53G3CpWHp2vn1K/Ko7clyUiFOG0IzsMdvfK/GSAm3HcbbQj74p6B/X/CmBAt3gxzU94zcaHgo+zNmIPea2M5nBe7tqsCOSbq3v/0DZyTeKehACoxFD4ehq7a1RCpqjzW4ANEMRDv/+dOUcF1MpJC6fgC70YrfgRjd2svHsM4rp2LuWsMHD6RmrHcspm+YFj31EIjLeBVFd87C3vfQRzpGd8zRCf5NPVX0EmyELuxGKOTy1GY2Z8vRFafobZcwRa6BubIqYub+Dk+gBmTjM1n1nufKgnIIxuPqA5wwwPGbefxFzM6GV9o6euGgyY3mQi95bjPBYVBa4CAgvVkdbe7tzrkkpSxSYD7pB+xDnepg4F73y6LhFWzRzPDWvsf6RtDbUDNvGOqGzsK4="

#notifications:
#  webhooks:
#    urls:
#      - secure: "Y8ZHoRwr1PRiBvnGRms3fHA8iznOhdESOwvKrAxRC6HJpqChZ3ScWoiDYk8DWEDDFnTx7uvozhDFGA1epZbpjtzRHeBC5zpbe9TvaPU1Ub8C7xGcg7+DVkQxV3esDr5gucdtuS1JB5KH/1rsLUWS06ymAb83CN1SVWajzA0yTYM1H2vm5G+ehikrEM+ACHyQQ8h40zojT9LRZAJmuqOhppQ6NmfL6MR4t5kEMRY/W37stsw0ne3tGWNRgj96Ho0Xf05HhwsGFPJ5hZKzL/oRMvc18/1UpWELn3Ax2fqjNlYLPk+R2yxrBO2Pib/9mJtXgdWS469NNm67CkczTUD1fGf+JlvvV4fKah9S6J2NHDRd69FmgTBzd16DOJUbrQqpSdnsvUt1N6wJHlUdmlY9/MRw2oKSzG0zY3Eg+u3wzeaCVdnFDcRA41qjjE5AVtTWX7oadyLlQnRgl9/yQYTsCfTpzpX4uXbScL7d17DFQ0VRJnsTWKYXCqwrgjEQQejLlQyD/ijgdE3ys/wAP+rpHj8/5MWYcG7OdnDblJUzLSfZDPmwb9esvT7ObU/ZRU+jgEnueKh7mxssKd5XonuEixiy8vHwT3DN0OHszoFkkxVLMVaENhpQlL75HWSw1T0lneEKBzOisK77iuuj+Z9CIXj9jb/QcUfcOLTgcx/rSNY="
#    on_success: change  # options: [always|never|change] default: always
#    on_failure: always  # options: [always|never|change] default: always
#    on_start: never     # options: [always|never|change] default: always
